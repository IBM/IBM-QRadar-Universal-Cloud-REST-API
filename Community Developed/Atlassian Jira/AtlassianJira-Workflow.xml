<?xml version="1.0" encoding="UTF-8" ?>
<Workflow name="AtlassianJira" version="1.0" xmlns="http://qradar.ibm.com/UniversalCloudRESTAPI/Workflow/V1">

    <Parameters>
        <Parameter name="host" label="host" required="true" />
        <Parameter name="token" label="token" required="true" />
	      <Parameter name="user_id" label="user_id" required="true" />
    </Parameters>

    <Actions>

        <Initialize path="/get_logs/offset" value="0" />
        <CallEndpoint url="https://${/host}/rest/api/3/auditing/record" method="GET" savePath="/get_logs">
	    <SSLConfiguration allowUntrustedServerCertificate="true" />
	    <BasicAuthentication username="${/user_id}" password="${/token}" />
	    <QueryParameter name="offset=" value="${/get_logs/offset}" />
	    <QueryParameter name="limit=" value="1000" />
            <RequestHeader name="Content-Type" value="application/json" />
        </CallEndpoint>

        <!-- Handle Errors -->
        <If condition="/get_logs/status_code != 200">
            <Abort reason="${/get_logs}" />
        </If>

        <!-- Post Events -->
        <PostEvents path="/get_logs/body/records" source="${/host}"/>

        <!-- Update the bookmark -->
        <Set path="/get_logs/offset" value="${/get_logs/body/total}" />

    </Actions>

    <Tests>
        <DNSResolutionTest host="${/host}" />
    </Tests>

</Workflow>
