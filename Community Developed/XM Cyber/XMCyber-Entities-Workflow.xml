<?xml version="1.0" encoding="UTF-8" ?>
<Workflow name="XM Cyber Entities" version="1.0"
    xmlns="http://qradar.ibm.com/UniversalCloudRESTAPI/Workflow/V2_1">

    <!-- Collect configurations from workflow parameter file -->
    <Parameters>
        <Parameter name="tenantName" label="Tenant Name" required="true"/>
        <Parameter name="apiKey" label="API Key" secret="true" required="true" />
        <Parameter name="ingestChokepointStats" label="Ingest Chokepoint Stats" required="true"/>
        <Parameter name="auditTrailsStartTime" label="Audit Trails Start Time" required="false"/>
        <Parameter name="ingestScenarios" label="Ingest Scenarios" required="false"/>
        <Parameter name="timeId" label="Time ID" required="false"/>
    </Parameters>

    <Actions>

        <!-- Clear status of log source -->
        <ClearStatus />

        <!-- Defining variables for running workflow -->
        <Set path="/xmCyberUrl" value="https://${/tenantName}"/>
        <Set path="/logPrefix" value="[XM_Cyber_App_for_QRadar][Entities][${/xmCyberUrl}]" />
        <Initialize path="/errorCount" value="0" />
        <Initialize path="/maxRetry" value="3" />
        <Initialize path="/authEndpoint" value="/api/auth" />
        <Initialize path="/refreshEndpoint" value="/api/refresh-token" />
        <Initialize path="/reportsEntitiesEndpoint" value="/api/v2/reports/data/scenariosCriticalAssetsReport/entities" />
        <Initialize path="/entitiesEndpoint" value="/api/entityInventory/entities" />
        <Initialize path="/chokepointStatsEndpoint" value="/api/v2/reports/data/scenariosChokePointsReport/chokePointsEntities" />
        <Initialize path="/pageSize" value="500" />
        <Initialize path="/refreshToken" value="" />
        <Initialize path="/accessToken" value="" />
        <Initialize path="/defaultSleepTime" value="60" />
        <Initialize path="/appVersion" value="2.0.0" />
        <Initialize path="/userAgentHeader" value="QRadar-v${/appVersion}" />
        <Initialize path="/collectionType" value="entities" />

        <Set path="/currentPage" value="1" />
        <Set path="/totalPages" value="1" />
        <Set path="/reportsCurrentPage" value="1" />
        <Set path="/reportsTotalPages" value="1" />

        <!-- Extract tenant prefix from tenantName -->
        <Split value="${/tenantName}" delimiter="\." savePath="/tenantParts" />
        <Set path="/tenantPrefix" value="${/tenantParts[0]}" />

        <!-- Print log in the /var/log/qradar.log file with info log level -->
        <Log type="INFO" message="${/logPrefix} - Entities collection started with ingestChokepointStats: ${/ingestChokepointStats}." />

        <Set path="/errorCount" value="0" />
        <Set path="/reportsEntitiesCompleted" value="false" />
        <Set path="/entitiesCompleted" value="false" />

        <!-- Perform data collection continuously in case of no error -->
        <While condition="${/errorCount + 0} &lt; ${/maxRetry + 0}">

            <!-- Create Refresh Token if it is not created -->
            <If condition="${empty(/refreshToken)} = 'true'">

                <Log type="INFO" message="${/logPrefix} - Refresh token not found. Creating new Access and Refresh token using provided API key." />

                <Set path="/rateLimitErrorCount" value="0" />
                <While condition="${/rateLimitErrorCount != ${/maxRetry}}">

                    <!-- Create Refresh token and Access Token using API key and save response at Jpath /refreshTokenResponse -->
                    <CallEndpoint url="${/xmCyberUrl}${/authEndpoint}" method="POST" savePath="/refreshTokenResponse">

                        <!-- Request header -->
                        <RequestHeader name="X-XMCYBER-CONNECTOR-NAME-VERSION" value="${/userAgentHeader}" />
                        <RequestHeader name="Content-Type" value="application/json" />
                        <RequestHeader name="x-api-key" value="${/apiKey}" />

                    </CallEndpoint>

                    <!-- Retry 3 times if the status code is 429. i.e API Rate limit exceeded. -->
                    <If condition="${/refreshTokenResponse/status_code} = 429">
                        <Set path="/rateLimitErrorCount" value="${/rateLimitErrorCount + 1}" />
                        <Log type="INFO" message="${/logPrefix} - API Rate limit exceeded. Status Code: 429." />
                        <If condition="${/rateLimitErrorCount = ${/maxRetry}}">
                            <Log type="INFO" message="${/logPrefix} Abort - The number of retry attempts (3) exceeded for status code = 429 while creating Access and Refresh token." />
                            <Abort reason="The number of retry attempts (3) exceeded for status code = 429 while creating Access and Refresh token." />
                        </If>

                        <Log type="INFO" message="${/logPrefix} - Sleeping for ${/defaultSleepTime} seconds." />
                        <Sleep duration="${/defaultSleepTime * 1000}" />
                    </If>
                    <Else>
                        <Set path="/rateLimitErrorCount" value="${/maxRetry}" />
                    </Else>
                </While>

                <!-- Storing Refresh token and Access token from API response -->
                <If condition="${/refreshTokenResponse/status_code} = 200">
                    <Log type="INFO" message="${/logPrefix} - Refresh token and Access token created successfully." />
                    <Set path="/refreshToken" value="${/refreshTokenResponse/body/refreshToken}" />
                    <Set path="/accessToken" value="${/refreshTokenResponse/body/accessToken}" />
                </If>

                <!-- Handle 401 Unauthorized -->
                <ElseIf condition="${/refreshTokenResponse/status_code} = 401">
                    <Log type="INFO" message="${/logPrefix} Abort - Invalid API token provided while collecting ${/collectionType} data. Status code = 401." />
                    <Abort reason="Invalid API token provided while collecting ${/collectionType} data. Status code = 401." />
                </ElseIf>

                <!-- Handle 403 Forbidden -->
                <ElseIf condition="${/refreshTokenResponse/status_code} = 403">
                    <Log type="INFO" message="${/logPrefix} Abort - Insufficient permissions while collecting ${/collectionType} data. Status code = 403." />
                    <Abort reason="Insufficient permissions while collecting ${/collectionType} data. Status code = 403." />
                </ElseIf>

                <!-- Aborting execution of workflow for http status code other than 200 -->
                <Else>
                    <Log type="INFO" message="${/logPrefix} Abort - API call failed while creating Access and Refresh token with status code - ${/refreshTokenResponse/status_code}, Body - ${/refreshTokenResponse/body}" />
                    <Abort reason="API call failed while creating Access and Refresh token with status code - ${/refreshTokenResponse/status_code}." />
                </Else>

            </If>
            <Else>
                <Log type="INFO" message="${/logPrefix} - Refresh token found. Creating new Access token using stored Refresh token." />
                <Set path="/rateLimitErrorCount" value="0" />
                <While condition="${/rateLimitErrorCount != ${/maxRetry}}">

                    <!-- Create an Access Token using Refresh token and save response at Jpath /accessTokenResponse-->
                    <CallEndpoint url="${/xmCyberUrl}${/refreshEndpoint}" method="POST" savePath="/accessTokenResponse">

                        <!-- Request header -->
                        <RequestHeader name="X-XMCYBER-CONNECTOR-NAME-VERSION" value="${/userAgentHeader}" />
                        <RequestHeader name="Content-Type" value="application/json" />

                        <!-- Request body with refresh token -->
                        <RequestBody type="application/json" encoding="UTF-8">
                        {
                            "refreshToken": "${/refreshToken}"
                        }
                        </RequestBody>
                    </CallEndpoint>

                    <!-- Retry 3 times if the status code is 429. i.e API Rate limit exceeded. -->
                    <If condition="${/accessTokenResponse/status_code} = 429">
                        <Set path="/rateLimitErrorCount" value="${/rateLimitErrorCount + 1}" />
                        <Log type="INFO" message="${/logPrefix} - API Rate limit exceeded. Status Code: 429." />
                        <If condition="${/rateLimitErrorCount = ${/maxRetry}}">
                            <Log type="INFO" message="${/logPrefix} Abort - The number of retry attempts (3) exceeded for status code = 429 while creating access token using saved refresh token." />
                            <Abort reason="The number of retry attempts (3) exceeded for status code = 429 while creating access token using saved refresh token." />
                        </If>

                        <Log type="INFO" message="${/logPrefix} - Sleeping for ${/defaultSleepTime} seconds." />
                        <Sleep duration="${/defaultSleepTime * 1000}" />
                    </If>
                    <Else>
                        <Set path="/rateLimitErrorCount" value="${/maxRetry}" />
                    </Else>
                </While>

                <!-- Storing Access token from API response -->
                <If condition="${/accessTokenResponse/status_code} = 200">
                    <Log type="INFO" message="${/logPrefix} - Access token created successfully." />
                    <Set path="/accessToken" value="${/accessTokenResponse/body/accessToken}" />
                </If>

                <!-- In case of expired Refresh token -->
                <ElseIf condition="${/accessTokenResponse/status_code} = 401 or ${/accessTokenResponse/status_code} = 400">

                    <Log type="INFO" message="${/logPrefix} - Refresh token is expired. Recreating an Access token and Refresh token using provided API key." />
                    <Set path="/rateLimitErrorCount" value="0" />
                    <While condition="${/rateLimitErrorCount != ${/maxRetry}}">

                        <!-- Create a Refresh token and Access Token using API key and save response at Jpath /refreshTokenResponse-->
                        <CallEndpoint url="${/xmCyberUrl}${/authEndpoint}" method="POST" savePath="/refreshTokenResponse">

                            <!-- Request header -->
                            <RequestHeader name="X-XMCYBER-CONNECTOR-NAME-VERSION" value="${/userAgentHeader}" />
                            <RequestHeader name="Content-Type" value="application/json" />
                            <RequestHeader name="x-api-key" value="${/apiKey}" />

                        </CallEndpoint>

                        <!-- Retry 3 times if the status code is 429. i.e API Rate limit exceeded. -->
                        <If condition="${/refreshTokenResponse/status_code} = 429">
                            <Set path="/rateLimitErrorCount" value="${/rateLimitErrorCount + 1}" />
                            <Log type="INFO" message="${/logPrefix} - API Rate limit exceeded. Status Code: 429." />
                            <If condition="${/rateLimitErrorCount = ${/maxRetry}}">
                                <Log type="INFO" message="${/logPrefix} Abort - The number of retry attempts (3) exceeded for status code = 429 while creating Access and Refresh token." />
                                <Abort reason="The number of retry attempts (3) exceeded for status code = 429 while creating Access and Refresh token." />
                            </If>

                            <Log type="INFO" message="${/logPrefix} - Sleeping for ${/defaultSleepTime} seconds." />
                            <Sleep duration="${/defaultSleepTime * 1000}" />
                        </If>
                        <Else>
                            <Set path="/rateLimitErrorCount" value="${/maxRetry}" />
                        </Else>
                    </While>

                    <!-- Storing Refresh token and Access token from API response -->
                    <If condition="${/refreshTokenResponse/status_code} = 200">
                        <Log type="INFO" message="${/logPrefix} - Refresh token and Access token created successfully." />
                        <Set path="/refreshToken" value="${/refreshTokenResponse/body/refreshToken}" />
                        <Set path="/accessToken" value="${/refreshTokenResponse/body/accessToken}" />
                    </If>

                    <!-- Aborting execution of workflow for failed API call -->
                    <Else>
                        <Log type="INFO" message="${/logPrefix} Abort - API call failed while creating Refresh and Access token with status code - ${/refreshTokenResponse/status_code}, Body - ${/refreshTokenResponse/body}" />
                        <Abort reason="API call failed while creating Refresh and Access token with status code - ${/refreshTokenResponse/status_code}." />
                    </Else>
                </ElseIf>

                <!-- Aborting execution of workflow for failed API call with status code other than 200 and 401 -->
                <Else>
                    <Log type="INFO" message="${/logPrefix} Abort - API call failed while creating Access token with status code - ${/accessTokenResponse/status_code}, Body - ${/accessTokenResponse/body}" />
                    <Abort reason="API call failed while creating Access token with status code - ${/accessTokenResponse/status_code}." />
                </Else>
            </Else>

            <!-- Reset errorCount after successful authentication -->
            <Set path="/errorCount" value="0" />
            <Set path="/loopBreaker" value="false" />
            <Set path="/reportsLoopBreaker" value="false" />

            <!-- Step 1: Collect and ingest reports entities data (compromised entities) -->
            <If condition="${/reportsEntitiesCompleted} = false">
                
                <While condition="${/reportsLoopBreaker} = false">
                    
                    <Log type="INFO" message="${/logPrefix} Collecting compromised entities data from ${/reportsEntitiesEndpoint} - Page ${/reportsCurrentPage}, pageSize ${/pageSize}." />
                    
                    <Set path="/rateLimitErrorCount" value="0" />
                    <While condition="${/rateLimitErrorCount != ${/maxRetry}}">
                        
                        <!-- Call reports entities API with OAuth authentication and pagination -->
                        <CallEndpoint url="${/xmCyberUrl}${/reportsEntitiesEndpoint}" method="GET" savePath="/reportsEntities/response">
                            <BearerAuthentication token="${/accessToken}" />
                            
                            <QueryParameter name="page" value="${/reportsCurrentPage}" />
                            <QueryParameter name="pageSize" value="${/pageSize}" />
                            
                            <RequestHeader name="X-XMCYBER-CONNECTOR-NAME-VERSION" value="${/userAgentHeader}" />
                            <RequestHeader name="accept" value="application/json" />
                            
                            <RequestBody type="application/json" encoding="UTF-8">
                            {
                                "Accept": "application/json",
                                "content-type": "application/x-www-form-urlencoded"
                            }
                            </RequestBody>
                        </CallEndpoint>
                        
                        <!-- Handle rate limit (429) -->
                        <If condition="${/reportsEntities/response/status_code} = 429">
                            <Set path="/rateLimitErrorCount" value="${/rateLimitErrorCount + 1}" />
                            <Log type="INFO" message="${/logPrefix} - API Rate limit exceeded for compromised entities. Status Code: 429." />
                            <If condition="${/rateLimitErrorCount = ${/maxRetry}}">
                                <Log type="INFO" message="${/logPrefix} Abort - The number of retry attempts (3) exceeded for status code = 429 while collecting compromised entities data." />
                                <Abort reason="The number of retry attempts (3) exceeded for status code = 429 while collecting compromised entities data." />
                            </If>
                            
                            <Log type="INFO" message="${/logPrefix} - Sleeping for ${/defaultSleepTime} seconds." />
                            <Sleep duration="${/defaultSleepTime * 1000}" />
                        </If>
                        <Else>
                            <Set path="/rateLimitErrorCount" value="${/maxRetry}" />
                        </Else>
                    </While>
                    
                    <!-- Handle successful response (200) -->
                    <If condition="/reportsEntities/response/status_code = 200">
                        
                        <!-- Extract pagination information -->
                        <Set path="/reportsTotalPages" value="${/reportsEntities/response/body/paging/totalPages}" />
                        <Set path="/reportsCurrentPageSize" value="${count(/reportsEntities/response/body/data)}" />
                        
                        <!-- Process and ingest each compromised entity -->
                        <ForEach item="/compromisedEntity" items="/reportsEntities/response/body/data">
                            <!-- Add standard metadata for compromised entities -->
                            <Set path="/compromisedEntity/event_id" value="compromised_entity" />
                            <Set path="/compromisedEntity/event_category" value="XM Cyber" />
                            <Set path="/compromisedEntity/tenant" value="${/tenantPrefix}" />
                            <PostEvent path="/compromisedEntity"/>
                        </ForEach>
                        
                        <!-- Log ingested count for current page -->
                        <Log type="INFO" message="${/logPrefix} - Page ${/reportsCurrentPage}: ${/reportsCurrentPageSize} compromised entities ingested in QRadar." />
                        
                        <!-- Check if there are more pages to process -->
                        <If condition="${/reportsCurrentPage + 0} &lt; ${/reportsTotalPages + 0}">
                            <Set path="/reportsCurrentPage" value="${/reportsCurrentPage + 1}" />
                            <Log type="INFO" message="${/logPrefix} - Moving to next compromised entities page: ${/reportsCurrentPage} of ${/reportsTotalPages}." />
                        </If>
                        <Else>
                            <!-- All pages processed, complete the collection -->
                            <Set path="/reportsLoopBreaker" value="true"/>
                            <Set path="/reportsEntitiesCompleted" value="true" />
                            <Log type="INFO" message="${/logPrefix} - Compromised entities collection completed successfully." />
                        </Else>
                        
                    </If>
                    
                    <!-- Handle token expired (419 or 401) -->
                    <ElseIf condition="${/reportsEntities/response/status_code} = 419 or ${/reportsEntities/response/status_code} = 401">
                        <!-- To retry for token expiration -->
                        <Set path="/reportsLoopBreaker" value="true"/>
                        <Set path="/errorCount" value="${/errorCount + 1}" />
                        <Log type="INFO" message="${/logPrefix} - Access token is expired with status code - ${/reportsEntities/response/status_code}." />
                        <Set path="/accessToken" value="" />
                    </ElseIf>
                    
                    <!-- Handle 403 Forbidden -->
                    <ElseIf condition="/reportsEntities/response/status_code = 403">
                        <Log type="INFO" message="${/logPrefix} Abort - Insufficient permissions while collecting compromised entities data. Status code = 403." />
                        <Abort reason="Insufficient permissions while collecting compromised entities data. Status code = 403." />
                    </ElseIf>
                    
                    <!-- Handle other error status codes -->
                    <Else>
                        <Log type="INFO" message="${/logPrefix} - API call failed for collecting compromised entities data with status code - ${/reportsEntities/response/status_code}, Body - ${/reportsEntities/response/body}" />
                        <Abort reason="API call failed for collecting compromised entities data with status code - ${/reportsEntities/response/status_code}." />
                    </Else>
                </While>
            </If>

            <!-- Step 2: Fetch entity inventory data and ingest -->
            <If condition="${/reportsEntitiesCompleted} = true and ${/entitiesCompleted} = false">
                <While condition="${/loopBreaker} = false">

                    <Log type="INFO" message="${/logPrefix} Collecting ${/collectionType} data from ${/entitiesEndpoint} - Page ${/currentPage}, pageSize ${/pageSize}." />

                    <Set path="/rateLimitErrorCount" value="0" />
                    <While condition="${/rateLimitErrorCount != ${/maxRetry}}">
                        
                        <!-- Call entities API with OAuth authentication and pagination -->
                        <CallEndpoint url="${/xmCyberUrl}${/entitiesEndpoint}" method="GET" savePath="/entities/response">
                            <BearerAuthentication token="${/accessToken}" />

                            <QueryParameter name="page" value="${/currentPage}" />
                            <QueryParameter name="pageSize" value="${/pageSize}" />

                            <RequestHeader name="X-XMCYBER-CONNECTOR-NAME-VERSION" value="${/userAgentHeader}" />
                            <RequestHeader name="accept" value="application/json" />

                            <RequestBody type="application/json" encoding="UTF-8">
                            {
                                "Accept": "application/json",
                                "content-type": "application/x-www-form-urlencoded"
                            }
                            </RequestBody>
                        </CallEndpoint>

                        <!-- Handle rate limit (429) -->
                        <If condition="${/entities/response/status_code} = 429">
                            <Set path="/rateLimitErrorCount" value="${/rateLimitErrorCount + 1}" />
                            <Log type="INFO" message="${/logPrefix} - API Rate limit exceeded. Status Code: 429." />
                            <If condition="${/rateLimitErrorCount = ${/maxRetry}}">
                                <Log type="INFO" message="${/logPrefix} Abort - The number of retry attempts (3) exceeded for status code = 429 while collecting ${/collectionType} data." />
                                <Abort reason="The number of retry attempts (3) exceeded for status code = 429 while collecting ${/collectionType} data." />
                            </If>

                            <Log type="INFO" message="${/logPrefix} - Sleeping for ${/defaultSleepTime} seconds." />
                            <Sleep duration="${/defaultSleepTime * 1000}" />
                        </If>
                        <Else>
                            <Set path="/rateLimitErrorCount" value="${/maxRetry}" />
                        </Else>
                    </While>

                    <!-- Handle successful response (200) -->
                    <If condition="/entities/response/status_code = 200">

                        <!-- Extract pagination information -->
                        <Set path="/totalPages" value="${/entities/response/body/paging/totalPages}" />
                        <Set path="/currentPageSize" value="${count(/entities/response/body/data)}" />
                        
                        <!-- Process collected inventory entities events and add metadata -->
                        <ForEach item="/currentEvent" items="/entities/response/body/data">
                            <!-- Add standard metadata -->
                            <Set path="/currentEvent/event_id" value="entity" />
                            <Set path="/currentEvent/event_category" value="XM Cyber" />
                            <Set path="/currentEvent/tenant" value="${/tenantPrefix}" />
                            <PostEvent path="/currentEvent"/>
                        </ForEach>

                        <!-- Log ingested event count for current page -->
                        <Log type="INFO" message="${/logPrefix} - Page ${/currentPage}: ${/currentPageSize} ${/collectionType} ingested in QRadar." />
                        
                        <!-- Check if there are more pages to process -->
                        <If condition="${/currentPage + 0} &lt; ${/totalPages + 0}">
                            <Set path="/currentPage" value="${/currentPage + 1}" />
                            <Log type="INFO" message="${/logPrefix} - Moving to next page: ${/currentPage} of ${/totalPages}." />
                        </If>
                        <Else>
                            <!-- All pages processed, complete the collection -->
                            <Set path="/loopBreaker" value="true"/>
                            <Set path="/entitiesCompleted" value="true" />
                            <Log type="INFO" message="${/logPrefix} Entities collection completed successfully." />
                        </Else>

                    </If>
                    
                    <!-- Handle token expired (419 or 401) -->
                    <ElseIf condition="${/entities/response/status_code} = 419 or ${/entities/response/status_code} = 401">
                        <!-- To retry for token expiration -->
                        <Set path="/loopBreaker" value="true"/>
                        <Set path="/errorCount" value="${/errorCount + 1}" />
                        <Log type="INFO" message="${/logPrefix} - Access token is expired with status code - ${/entities/response/status_code}." />
                        <Set path="/accessToken" value="" />
                    </ElseIf>

                    <!-- Handle 403 Forbidden -->
                    <ElseIf condition="/entities/response/status_code = 403">
                        <Log type="INFO" message="${/logPrefix} Abort - Insufficient permissions while collecting ${/collectionType} data. Status code = 403." />
                        <Abort reason="Insufficient permissions while collecting ${/collectionType} data. Status code = 403." />
                    </ElseIf>

                    <!-- Handle other error status codes -->
                    <Else>
                        <Log type="INFO" message="${/logPrefix} - API call failed for collecting ${/collectionType} data with status code - ${/entities/response/status_code}, Body - ${/entities/response/body}" />
                        <Abort reason="API call failed for collecting ${/collectionType} data with status code - ${/entities/response/status_code}." />
                    </Else>
                </While>
            </If>

            <!-- Fetch chokepoint stats if enabled -->
            <If condition="${/entitiesCompleted} = true">
                <If condition="${'${lower(/ingestChokepointStats)}' = 'true'}">
                    <Log type="INFO" message="${/logPrefix} - Collecting chokepoint stats from ${/chokepointStatsEndpoint}." />

                    <Set path="/rateLimitErrorCount" value="0" />
                    <While condition="${/rateLimitErrorCount != ${/maxRetry}}">  
                        <!-- Access-Token-based authentication -->
                        <CallEndpoint url="${/xmCyberUrl}${/chokepointStatsEndpoint}" method="GET" savePath="/chokepointStats/response">
                            <BearerAuthentication token="${/accessToken}" />

                            <RequestHeader name="X-XMCYBER-CONNECTOR-NAME-VERSION" value="${/userAgentHeader}" />
                            <RequestHeader name="accept" value="application/json" />

                            <RequestBody type="application/json" encoding="UTF-8">
                            {
                                "Accept": "application/json",
                                "content-type": "application/x-www-form-urlencoded"
                            }
                            </RequestBody>
                        </CallEndpoint>

                        <!-- Handle rate limit (429) -->
                        <If condition="${/chokepointStats/response/status_code} = 429">
                            <Set path="/rateLimitErrorCount" value="${/rateLimitErrorCount + 1}" />
                            <Log type="INFO" message="${/logPrefix} - API Rate limit exceeded for chokepoint stats. Status Code: 429." />
                            <If condition="${/rateLimitErrorCount = ${/maxRetry}}">
                                <Log type="INFO" message="${/logPrefix} Abort - The number of retry attempts (3) exceeded for status code = 429 while collecting chokepoint stats." />
                                <Abort reason="The number of retry attempts (3) exceeded for status code = 429 while collecting chokepoint stats." />
                            </If>

                            <Log type="INFO" message="${/logPrefix} - Sleeping for ${/defaultSleepTime} seconds." />
                            <Sleep duration="${/defaultSleepTime * 1000}" />
                        </If>
                        <Else>
                            <Set path="/rateLimitErrorCount" value="${/maxRetry}" />
                        </Else>
                    </While>

                    <!-- Handle successful chokepoint stats response (200) -->
                    <If condition="/chokepointStats/response/status_code = 200">
                        <!-- Extract total count from paging information -->
                        <Set path="/totalChokepointCount" value="${/chokepointStats/response/body/paging/total}" />
                        
                        <!-- Create chokepoint stats event -->
                        <Set path="/chokepointEvent/totalChokepoint" value="${/totalChokepointCount}" />
                        <Set path="/chokepointEvent/event_id" value="entities_chokepoint" />
                        <Set path="/chokepointEvent/event_category" value="XM Cyber" />
                        <Set path="/chokepointEvent/tenant" value="${/tenantPrefix}" />
                        <PostEvent path="/chokepointEvent"/>

                        <Set path="/errorCount" value="${/maxRetry}"/>
                        <Log type="INFO" message="${/logPrefix} - Chokepoint stats ingested successfully. Total chokepoints: ${/totalChokepointCount}." />
                    </If>
                    
                    <!-- Handle token expired (419) for chokepoint stats -->
                    <ElseIf condition="${/chokepointStats/response/status_code} = 419 or ${/chokepointStats/response/status_code} = 401">
                        <Set path="/errorCount" value="${/errorCount + 1}" />
                        <Log type="INFO" message="${/logPrefix} - Access token is expired with status code - ${/chokepointStats/response/status_code} while collecting chokepoint stats." />
                        <Set path="/accessToken" value="" />
                    </ElseIf>

                    <!-- Handle 403 Forbidden for chokepoint stats -->
                    <ElseIf condition="/chokepointStats/response/status_code = 403">
                        <Log type="INFO" message="${/logPrefix} Abort - Insufficient permissions while collecting chokepoint stats. Status code = 403." />
                        <Abort reason="Insufficient permissions while collecting chokepoint stats. Status code = 403." />
                    </ElseIf>

                    <!-- Handle other error status codes for chokepoint stats -->
                    <Else>
                        <Log type="INFO" message="${/logPrefix} - API call failed for collecting chokepoint stats with status code - ${/chokepointStats/response/status_code}, Body - ${/chokepointStats/response/body}" />
                        <Abort reason="API call failed for collecting chokepoint stats with status code - ${/chokepointStats/response/status_code}." />
                    </Else>
                </If>
                <Else>
                    <Set path="/errorCount" value="${/maxRetry}"/>
                    <Log type="INFO" message="${/logPrefix} - Chokepoint stats collection is disabled (ingestChokepointStats = ${/ingestChokepointStats})." />
                </Else>
            </If>
        </While>
    </Actions>

    <!-- Performing some connectivity tests -->
    <Tests>
        <DNSResolutionTest host="${/tenantName}" />
        <TCPConnectionTest host="${/tenantName}" />
        <SSLHandshakeTest host="${/tenantName}" />
        <HTTPConnectionThroughProxyTest url="https://${/tenantName}" />
    </Tests>

</Workflow>
