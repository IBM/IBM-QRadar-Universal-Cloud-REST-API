<?xml version="1.0" encoding="UTF-8" ?>
<Workflow name="XM Cyber Security Score" version="1.0"
    xmlns="http://qradar.ibm.com/UniversalCloudRESTAPI/Workflow/V2_1">

    <!-- Collect configurations from workflow parameter file -->
    <Parameters>
        <Parameter name="tenantName" label="Tenant Name" required="true"/>
        <Parameter name="apiKey" label="API Key" secret="true" required="true" />
        <Parameter name="ingestScenarios" label="Ingest Scenarios" required="true"/>
        <Parameter name="timeId" label="Time ID" required="true"/>
        <Parameter name="auditTrailsStartTime" label="Audit Trails Start Time" required="false"/>
        <Parameter name="ingestChokepointStats" label="Ingest Chokepoint Stats" required="false"/>
    </Parameters>

    <Actions>

        <!-- Clear status of log source -->
        <ClearStatus />

        <!-- Defining variables for running workflow -->
        <Set path="/xmCyberUrl" value="https://${/tenantName}"/>
        <Set path="/logPrefix" value="[XM_Cyber_App_for_QRadar][SecurityScore][${/xmCyberUrl}]" />
        <Initialize path="/errorCount" value="0" />
        <Initialize path="/maxRetry" value="3" />
        <Initialize path="/authEndpoint" value="/api/auth" />
        <Initialize path="/refreshEndpoint" value="/api/refresh-token" />
        <Initialize path="/securityScoreEndpoint" value="/api/systemReport/riskScoreV2" />
        <Initialize path="/refreshToken" value="" />
        <Initialize path="/accessToken" value="" />
        <Initialize path="/defaultSleepTime" value="60" />
        <Initialize path="/appVersion" value="2.0.0" />
        <Initialize path="/userAgentHeader" value="QRadar-v${/appVersion}" />
        <Initialize path="/collectionType" value="security_score" />
        <Initialize path="/trimmedData" value="[]" />
        
        <!-- Validate timeId parameter -->
        <If condition="${/timeId != 'timeAgo_days_7' and /timeId != 'timeAgo_days_14' and /timeId != 'timeAgo_days_30' and /timeId != 'timeAgo_days_365'}">
            <Log type="INFO" message="${/logPrefix} - Invalid timeId value: ${/timeId}. Must be one of: timeAgo_days_7, timeAgo_days_14, timeAgo_days_30, timeAgo_days_365" />
            <Abort reason="Invalid timeId parameter. Must be one of: timeAgo_days_7, timeAgo_days_14, timeAgo_days_30, timeAgo_days_365" />
        </If>

        <!-- Extract tenant prefix from tenantName -->
        <Split value="${/tenantName}" delimiter="\." savePath="/tenantParts" />
        <Set path="/tenantPrefix" value="${/tenantParts[0]}" />

        <!-- Print log in the /var/log/qradar.log file with info log level -->
        <Log type="INFO" message="${/logPrefix} - Security Score collection started with timeId: ${/timeId}, ingestScenarios: ${/ingestScenarios}." />

        <Set path="/errorCount" value="0" />

        <!-- Perform data collection continuously in case of no error -->
        <While condition="${/errorCount != ${/maxRetry}}">

            <!-- Create Refresh Token if it is not created -->
            <If condition="${empty(/refreshToken)} = 'true'">

                <Log type="INFO" message="${/logPrefix} - Refresh token not found. Creating new Access and Refresh token using provided API key." />

                <Set path="/rateLimitErrorCount" value="0" />
                <While condition="${/rateLimitErrorCount != ${/maxRetry}}">

                    <!-- Create Refresh token and Access Token using API key and save response at Jpath /refreshTokenResponse -->
                    <CallEndpoint url="${/xmCyberUrl}${/authEndpoint}" method="POST" savePath="/refreshTokenResponse">

                        <!-- Request header -->
                        <RequestHeader name="X-XMCYBER-CONNECTOR-NAME-VERSION" value="${/userAgentHeader}" />
                        <RequestHeader name="Content-Type" value="application/json" />
                        <RequestHeader name="x-api-key" value="${/apiKey}" />

                    </CallEndpoint>

                    <!-- Retry 3 times if the status code is 429. i.e API Rate limit exceeded. -->
                    <If condition="${/refreshTokenResponse/status_code} = 429">
                        <Set path="/rateLimitErrorCount" value="${/rateLimitErrorCount + 1}" />
                        <Log type="INFO" message="${/logPrefix} - API Rate limit exceeded. Status Code: 429." />
                        <If condition="${/rateLimitErrorCount = ${/maxRetry}}">
                            <Log type="INFO" message="${/logPrefix} Abort - The number of retry attempts (3) exceeded for status code = 429 while creating Access and Refresh token." />
                            <Abort reason="The number of retry attempts (3) exceeded for status code = 429 while creating Access and Refresh token." />
                        </If>

                        <Log type="INFO" message="${/logPrefix} - Sleeping for ${/defaultSleepTime} seconds." />
                        <Sleep duration="${/defaultSleepTime * 1000}" />
                    </If>
                    <Else>
                        <Set path="/rateLimitErrorCount" value="${/maxRetry}" />
                    </Else>
                </While>

                <!-- Storing Refresh token and Access token from API response -->
                <If condition="${/refreshTokenResponse/status_code} = 200">
                    <Log type="INFO" message="${/logPrefix} - Refresh token and Access token created successfully." />
                    <Set path="/refreshToken" value="${/refreshTokenResponse/body/refreshToken}" />
                    <Set path="/accessToken" value="${/refreshTokenResponse/body/accessToken}" />
                </If>

                <!-- Handle 401 Unauthorized -->
                <ElseIf condition="${/refreshTokenResponse/status_code} = 401">
                    <Log type="INFO" message="${/logPrefix} Abort - Invalid API token provided while collecting ${/collectionType} data. Status code = 401." />
                    <Abort reason="Invalid API token provided while collecting ${/collectionType} data. Status code = 401." />
                </ElseIf>

                <!-- Handle 403 Forbidden -->
                <ElseIf condition="${/refreshTokenResponse/status_code} = 403">
                    <Log type="INFO" message="${/logPrefix} Abort - Insufficient permissions while collecting ${/collectionType} data. Status code = 403." />
                    <Abort reason="Insufficient permissions while collecting ${/collectionType} data. Status code = 403." />
                </ElseIf>

                <!-- Aborting execution of workflow for http status code other than 200 -->
                <Else>
                    <Log type="INFO" message="${/logPrefix} Abort - API call failed while creating Access and Refresh token with status code - ${/refreshTokenResponse/status_code}, Body - ${/refreshTokenResponse/body}" />
                    <Abort reason="API call failed while creating Access and Refresh token with status code - ${/refreshTokenResponse/status_code}." />
                </Else>

            </If>
            <Else>
                <Log type="INFO" message="${/logPrefix} - Refresh token found. Creating new Access token using stored Refresh token." />
                <Set path="/rateLimitErrorCount" value="0" />
                <While condition="${/rateLimitErrorCount != ${/maxRetry}}">

                    <!-- Create an Access Token using Refresh token and save response at Jpath /accessTokenResponse-->
                    <CallEndpoint url="${/xmCyberUrl}${/refreshEndpoint}" method="POST" savePath="/accessTokenResponse">

                        <!-- Request header -->
                        <RequestHeader name="X-XMCYBER-CONNECTOR-NAME-VERSION" value="${/userAgentHeader}" />
                        <RequestHeader name="Content-Type" value="application/json" />

                        <!-- Request body with refresh token -->
                        <RequestBody type="application/json" encoding="UTF-8">
                        {
                            "refreshToken": "${/refreshToken}"
                        }
                        </RequestBody>
                    </CallEndpoint>

                    <!-- Retry 3 times if the status code is 429. i.e API Rate limit exceeded. -->
                    <If condition="${/accessTokenResponse/status_code} = 429">
                        <Set path="/rateLimitErrorCount" value="${/rateLimitErrorCount + 1}" />
                        <Log type="INFO" message="${/logPrefix} - API Rate limit exceeded. Status Code: 429." />
                        <If condition="${/rateLimitErrorCount = ${/maxRetry}}">
                            <Log type="INFO" message="${/logPrefix} Abort - The number of retry attempts (3) exceeded for status code = 429 while creating access token using saved refresh token." />
                            <Abort reason="The number of retry attempts (3) exceeded for status code = 429 while creating access token using saved refresh token." />
                        </If>

                        <Log type="INFO" message="${/logPrefix} - Sleeping for ${/defaultSleepTime} seconds." />
                        <Sleep duration="${/defaultSleepTime * 1000}" />
                    </If>
                    <Else>
                        <Set path="/rateLimitErrorCount" value="${/maxRetry}" />
                    </Else>
                </While>

                <!-- Storing Access token from API response -->
                <If condition="${/accessTokenResponse/status_code} = 200">
                    <Log type="INFO" message="${/logPrefix} - Access token created successfully." />
                    <Set path="/accessToken" value="${/accessTokenResponse/body/accessToken}" />
                </If>

                <!-- In case of expired Refresh token -->
                <ElseIf condition="${/accessTokenResponse/status_code} = 401 or ${/accessTokenResponse/status_code} = 400">

                    <Log type="INFO" message="${/logPrefix} - Refresh token is expired. Recreating an Access token and Refresh token using provided API key." />
                    <Set path="/rateLimitErrorCount" value="0" />
                    <While condition="${/rateLimitErrorCount != ${/maxRetry}}">

                        <!-- Create a Refresh token and Access Token using API key and save response at Jpath /refreshTokenResponse-->
                        <CallEndpoint url="${/xmCyberUrl}${/authEndpoint}" method="POST" savePath="/refreshTokenResponse">

                            <!-- Request header -->
                            <RequestHeader name="X-XMCYBER-CONNECTOR-NAME-VERSION" value="${/userAgentHeader}" />
                            <RequestHeader name="Content-Type" value="application/json" />
                            <RequestHeader name="x-api-key" value="${/apiKey}" />

                        </CallEndpoint>

                        <!-- Retry 3 times if the status code is 429. i.e API Rate limit exceeded. -->
                        <If condition="${/refreshTokenResponse/status_code} = 429">
                            <Set path="/rateLimitErrorCount" value="${/rateLimitErrorCount + 1}" />
                            <Log type="INFO" message="${/logPrefix} - API Rate limit exceeded. Status Code: 429." />
                            <If condition="${/rateLimitErrorCount = ${/maxRetry}}">
                                <Log type="INFO" message="${/logPrefix} Abort - The number of retry attempts (3) exceeded for status code = 429 while creating Access and Refresh token." />
                                <Abort reason="The number of retry attempts (3) exceeded for status code = 429 while creating Access and Refresh token." />
                            </If>

                            <Log type="INFO" message="${/logPrefix} - Sleeping for ${/defaultSleepTime} seconds." />
                            <Sleep duration="${/defaultSleepTime * 1000}" />
                        </If>
                        <Else>
                            <Set path="/rateLimitErrorCount" value="${/maxRetry}" />
                        </Else>
                    </While>

                    <!-- Storing Refresh token and Access token from API response -->
                    <If condition="${/refreshTokenResponse/status_code} = 200">
                        <Log type="INFO" message="${/logPrefix} - Refresh token and Access token created successfully." />
                        <Set path="/refreshToken" value="${/refreshTokenResponse/body/refreshToken}" />
                        <Set path="/accessToken" value="${/refreshTokenResponse/body/accessToken}" />
                    </If>

                    <!-- Aborting execution of workflow for failed API call -->
                    <Else>
                        <Log type="INFO" message="${/logPrefix} Abort - API call failed while creating Refresh and Access token with status code - ${/refreshTokenResponse/status_code}, Body - ${/refreshTokenResponse/body}" />
                        <Abort reason="API call failed while creating Refresh and Access token with status code - ${/refreshTokenResponse/status_code}." />
                    </Else>
                </ElseIf>

                <!-- Aborting execution of workflow for failed API call with status code other than 200 and 401 -->
                <Else>
                    <Log type="INFO" message="${/logPrefix} Abort - API call failed while creating Access token with status code - ${/accessTokenResponse/status_code}, Body - ${/accessTokenResponse/body}" />
                    <Abort reason="API call failed while creating Access token with status code - ${/accessTokenResponse/status_code}." />
                </Else>
            </Else>

            <!-- Reset errorCount after successful authentication -->
            <Set path="/errorCount" value="0" />
            <Set path="/loopBreaker" value="false" />

            <!-- Fetch security score data with retry mechanism -->
            <While condition="${/loopBreaker} = false">

                <Log type="INFO" message="${/logPrefix} Collecting ${/collectionType} data from ${/securityScoreEndpoint} with timeId: ${/timeId} and resolution: 1." />

                <Set path="/rateLimitErrorCount" value="0" />
                <While condition="${/rateLimitErrorCount != ${/maxRetry}}">
                    
                    <!-- Call security score API with OAuth authentication -->
                    <CallEndpoint url="${/xmCyberUrl}${/securityScoreEndpoint}" method="GET" savePath="/securityScore/response">
                        <BearerAuthentication token="${/accessToken}" />

                        <QueryParameter name="timeId" value="${/timeId}" />
                        <QueryParameter name="resolution" value="1" />

                        <RequestHeader name="X-XMCYBER-CONNECTOR-NAME-VERSION" value="${/userAgentHeader}" />

                        <RequestBody type="application/json" encoding="UTF-8">
                        {
                            "Accept": "application/json",
                            "content-type": "application/x-www-form-urlencoded"
                        }
                        </RequestBody>
                    </CallEndpoint>

                    <!-- Handle rate limit (429) -->
                    <If condition="${/securityScore/response/status_code} = 429">
                        <Set path="/rateLimitErrorCount" value="${/rateLimitErrorCount + 1}" />
                        <Log type="INFO" message="${/logPrefix} - API Rate limit exceeded. Status Code: 429." />
                        <If condition="${/rateLimitErrorCount = ${/maxRetry}}">
                            <Log type="INFO" message="${/logPrefix} Abort - The number of retry attempts (3) exceeded for status code = 429 while collecting ${/collectionType} data." />
                            <Abort reason="The number of retry attempts (3) exceeded for status code = 429 while collecting ${/collectionType} data." />
                        </If>

                        <Log type="INFO" message="${/logPrefix} - Sleeping for ${/defaultSleepTime} seconds." />
                        <Sleep duration="${/defaultSleepTime * 1000}" />
                    </If>
                    <Else>
                        <Set path="/rateLimitErrorCount" value="${/maxRetry}" />
                    </Else>
                </While>

                <!-- Handle successful response (200) -->
                <If condition="/securityScore/response/status_code = 200">

                    <!-- Process main security score data (remove scenarios array and ingest as single event) -->
                    <Set path="/securityScoreData" value="${/securityScore/response/body/data}" />
                    
                    <!-- Validate if security score data is not empty before ingesting -->
                    <If condition="${empty(/securityScoreData)} = false">
                        <!-- Remove scenarios array from the main data -->
                        <Delete path="/securityScoreData/scenarios"/>
                        
                        <!-- Add metadata to security score event -->
                        <Set path="/securityScoreData/event_id" value="security_score" />
                        <Set path="/securityScoreData/event_category" value="XM Cyber" />
                        <Set path="/securityScoreData/tenant" value="${/tenantPrefix}" />
                        
                        <!-- Ingest main security score event -->
                        <PostEvent path="/securityScoreData"/>
                        <Log type="INFO" message="${/logPrefix} - Security score data ingested in QRadar." />
                    </If>
                    <Else>
                        <Log type="INFO" message="${/logPrefix} - Security score data is empty. " />
                    </Else>

                    <!-- Check if scenarios should be ingested -->
                    <If condition="${'${lower(/ingestScenarios)}' = 'true'}">
                        <Log type="INFO" message="${/logPrefix} - Processing scenarios data for ingestion." />
                        
                        <!-- Process each scenario individually -->
                        <Set path="/scenariosCount" value="0" />
                        <ForEach item="/currentScenario" items="/securityScore/response/body/data/scenarios">
                            <!-- Limit graphData to last 30 objects if more than 30 exist -->
                            <Set path="/graphCount" value="${count(/currentScenario/graphData)}" />
                            <If condition="${/graphCount + 0} &gt; 30">
                                <!-- Process last 30 entries and extract only required fields (fromDate, toDate, score) -->
                                <Set path="/trimmedData" value="[]" />
                                <Set path="/startIndex" value="${/graphCount - 30}" />
                                <Set path="/currentIndex" value="${/startIndex + 0}" />
                                <While condition="${/currentIndex + 0} &lt; ${/graphCount + 0}">
                                    <!-- Delete Campain and Grade fields -->
                                    <Delete path="/currentScenario/graphData[${/currentIndex}]/campaigns" />
                                    <Delete path="/currentScenario/graphData[${/currentIndex}]/grade" />
                                    <Add path="/trimmedData" value="${/currentScenario/graphData[${/currentIndex}]}" />
                                    <Set path="/currentIndex" value="${/currentIndex + 1}" />
                                </While>
                                <Set path="/currentScenario/graphData" value="${/trimmedData}" />
                            </If>
                            <Else>
                                <!-- Process all entries and remove unwanted fields directly -->
                                <Set path="/currentIndex" value="0" />
                                <While condition="${/currentIndex + 0} &lt; ${/graphCount + 0}">
                                    <!-- Delete Campain and Grade fields -->
                                    <Delete path="/currentScenario/graphData[${/currentIndex}]/campaigns" />
                                    <Delete path="/currentScenario/graphData[${/currentIndex}]/grade" />
                                    <Set path="/currentIndex" value="${/currentIndex + 1}" />
                                </While>
                            </Else>

                            <!-- Add metadata to each scenario event -->
                            <Set path="/currentScenario/event_id" value="security_score_scenario" />
                            <Set path="/currentScenario/event_category" value="XM Cyber" />
                            <Set path="/currentScenario/tenant" value="${/tenantPrefix}" />
                            
                            <!-- Ingest individual scenario event -->
                            <PostEvent path="/currentScenario"/>
                            <Set path="/scenariosCount" value="${/scenariosCount + 1}" />
                        </ForEach>
                        
                        <Log type="INFO" message="${/logPrefix} - ${/scenariosCount} scenario events ingested in QRadar." />
                    </If>
                    <Else>
                        <Log type="INFO" message="${/logPrefix} - Scenarios ingestion is disabled (ingestScenarios = ${/ingestScenarios})." />
                    </Else>

                    <!-- Complete the collection -->
                    <Set path="/loopBreaker" value="true"/>
                    <Set path="/errorCount" value="${/maxRetry}"/>
                    <Log type="INFO" message="${/logPrefix} Security Score collection completed successfully." />

                </If>
                
                <!-- Handle token expired (419 or 401) -->
                <ElseIf condition="${/securityScore/response/status_code} = 419 or ${/securityScore/response/status_code} = 401">
                    <!-- To retry for token expiration -->
                    <Set path="/loopBreaker" value="true"/>
                    <Set path="/errorCount" value="${/errorCount + 1}" />
                    <Log type="INFO" message="${/logPrefix} - Access token is expired with status code - ${/securityScore/response/status_code}." />
                    <Set path="/accessToken" value="" />
                </ElseIf>

                <!-- Handle 403 Forbidden -->
                <ElseIf condition="/securityScore/response/status_code = 403">
                    <Log type="INFO" message="${/logPrefix} Abort - Insufficient permissions while collecting ${/collectionType} data. Status code = 403." />
                    <Abort reason="Insufficient permissions while collecting ${/collectionType} data. Status code = 403." />
                </ElseIf>

                <!-- Handle other error status codes -->
                <Else>
                    <Log type="INFO" message="${/logPrefix} - API call failed for collecting ${/collectionType} data with status code - ${/securityScore/response/status_code}, Body - ${/securityScore/response/body}" />
                    <Abort reason="API call failed for collecting ${/collectionType} data with status code - ${/securityScore/response/status_code}." />
                </Else>
            </While>
        </While>
    </Actions>

    <!-- Performing some connectivity tests -->
    <Tests>
        <DNSResolutionTest host="${/tenantName}" />
        <TCPConnectionTest host="${/tenantName}" />
        <SSLHandshakeTest host="${/tenantName}" />
        <HTTPConnectionThroughProxyTest url="https://${/tenantName}" />
    </Tests>

</Workflow>
