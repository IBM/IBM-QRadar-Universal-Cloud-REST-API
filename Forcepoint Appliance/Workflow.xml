<Workflow name="Test" version="1.0" xmlns="http://qradar.ibm.com/UniversalCloudRESTAPI/Workflow/V1">
    <Parameters>
        <Parameter name="host" label="xxx.com" required="true" />
        <Parameter name="username" label="" required="true" />
        <Parameter name="password" label="" required="true" secret="true"/>
        <Parameter name="max_download_children" label="1" required="true" />
        <Parameter name="destination" label="/tmp" required="true" />
        <Parameter name="pidfile" label="/tmp/ftl.pid" required="true" />
        <Parameter name="stream" label="all" required="true" />
    </Parameters>
    <Actions>
        <!-- Get the Events -->
	<CallEndpoint url="https://${/host}" method="GET" savePath="/get_events/body">
			<BasicAuthentication username="${/username}" password="${/password}" />
			<QueryParameter name="max_download_children" value="${/max_download_children}"/>
			<QueryParameter name="destination" value="${/destination}" />
		        <QueryParameter name="pidfile" value="${/pidfile}"/>
			<QueryParameter name="stream" value="${/stream}" />
			<RequestHeader name="Accept" value="application/json" />
                
	</CallEndpoint>
		
	<!-- Handle Errors -->
        <If condition="/get_events/status_code != 200">
            <Abort reason="${/get_events/body}" />

        </If>

        <!-- Post Events, if any -->
        <If condition="count(/get_events/body/items) > 0">
            <PostEvents path="/get_events/body/items" source="${/api_host}" />

            <!-- Update the bookmark -->
            <ParseDate pattern="yyyy-MM-dd'T'HH:mm:ss[.SSS]'Z'" timeZone="UTC" date="${max(/get_events/body/items)}" savePath="/last_event_time" />
            <FormatDate pattern="yyyy-MM-dd'T'HH:mm:ss.SSS'Z'" timeZone="UTC" time="${/last_event_time + 1}" savePath="/bookmark" />
        </If

    </Actions>

    <Tests>
        <DNSResolutionTest host="${/host}" />
        <TCPConnectionTest host="${/host}" />
        <SSLHandshakeTest host="${/host}" />
        <HTTPConnectionThroughProxyTest url="https://${/host}" />
    </Tests>

</Workflow>
